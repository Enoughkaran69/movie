<html>
<head>
  <title>Playing</title>
  <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .video-js {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
<video id="my-video-player" class="video-js" controls preload="auto"></video>

<script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/videojs-contrib-hls/dist/videojs-contrib-hls.min.js"></script>

<script type="text/javascript">
  async function setupPlayer() {
    try {
      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
      }

      const id = getQueryParams();
      const hValue = localStorage.getItem('t_hash_t') || '';

      // Fetch the JSON data
      const response = await fetch(`https://cors.karankingrider.workers.dev/?url=https://flask-hello-world-coral-kappa-40.vercel.app/m?h=${encodeURIComponent(hValue)}&q=${encodeURIComponent(id)}`);
      const data = await response.json();

      // Extract video information
      const searchResult = data.searchResult[0];
      const image = searchResult.image;

      // Filter sources for Full HD resolution
      const fullHdSource = searchResult.sources.find(source => source.label === "Full HD");
      const videoSource = fullHdSource
        ? {
            src: `https://iosmirror.cc${fullHdSource.file.replace('::su', '::ni')}`, // Adjust the region
            type: "application/vnd.apple.mpegurl"
          }
        : null;

      // Prepare subtitle tracks
      const tracks = searchResult.tracks
        .filter(track => track.kind === "captions")
        .map(track => ({
          src: track.file.startsWith("//") ? `https:${track.file}` : track.file,
          kind: track.kind,
          label: track.label,
          srclang: track.label.toLowerCase(), // Set language code
          default: track.label === "Hindi"
        }));

      // Initialize Video.js player
      const player = videojs("my-video-player", {
        controls: true,
        autoplay: false,
        preload: "auto",
        poster: image,
        fluid: true,
        sources: videoSource ? [videoSource] : [],
        tracks: tracks
      });

      // Add subtitle tracks dynamically
      tracks.forEach(track => {
        player.addRemoteTextTrack(
          {
            src: track.src,
            kind: track.kind,
            label: track.label,
            srclang: track.srclang,
            default: track.default
          },
          false
        );
      });

      // Handle errors
      player.on("error", () => {
        console.error("Error occurred in the video player");
      });
    } catch (error) {
      console.error("Error setting up the player:", error);
    }
  }

  // Initialize the player
  setupPlayer();
</script>
</body>
</html>
