<html>
<head>
  <title>Playing</title>
  <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    .video-js {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
<video id="my-video-player" class="video-js" controls preload="auto"></video>

<script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/videojs-contrib-hls/dist/videojs-contrib-hls.min.js"></script>

<script type="text/javascript">
  async function setupPlayer() {
    try {
      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
      }

      const id = getQueryParams();
      const hValue = localStorage.getItem('t_hash_t') || '';

      // Fetch the JSON data
      const response = await fetch(`https://cors.karankingrider.workers.dev/?url=https://flask-hello-world-coral-kappa-40.vercel.app/hd?h=${encodeURIComponent(hValue)}&q=${encodeURIComponent(id)}`);
      const data = await response.json();

      // Extract the searchResult string
      const searchResult = data.searchResult;

      // Parse the M3U8 playlist format from the response string
      const lines = searchResult.split("\n").filter(line => line.trim() !== "");
      const videoSources = lines.filter(line => line.startsWith("https://"));

      // Adjust region (replace "::su" with "::ni") for each video source
      const adjustedSources = videoSources.map(source => {
        return source.replace('::su', '::ni');
      });

      // Initialize Video.js player
      const player = videojs("my-video-player", {
        controls: true,
        autoplay: false,
        preload: "auto",
        fluid: true,
        sources: adjustedSources.map(src => ({
          src: src,
          type: "application/vnd.apple.mpegurl"
        }))
      });

      // Handle errors
      player.on("error", () => {
        console.error("Error occurred in the video player");
      });
    } catch (error) {
      console.error("Error setting up the player:", error);
    }
  }

  // Initialize the player
  setupPlayer();
</script>
</body>
</html>
